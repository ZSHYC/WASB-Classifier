<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session 59e7323d-bca5-4155-b683-97e8ca4cd542 (2026-02-04 05:59Z) -->

# WASB 模型预测精度提升策略 (2026-02-04 05:59Z)

_**User**_

请你帮我仔细阅读一下我的项目，这个项目的训练过程是怎么样的，可以调整什么参数来提高预测精度，我只用wasb模型
详细给我介绍一下，我不想改变训练过程，只用现在现有的模型权重，有没有办法提高预测进度，不要改我的代码，给我详细讲解一下能做的措施，尽可能详细，越仔细越好

---

_**Agent (model default, mode Agent)**_


正在阅读项目，梳理训练与推理流程，并找出在不改代码、仅用现有 WASB 权重下可提高预测精度的措施。


---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: C:\Users\mayuchao\Desktop\WASB-SBDT\src\main.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: C:\Users\mayuchao\Desktop\WASB-SBDT\README.md</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: C:\Users\mayuchao\Desktop\WASB-SBDT\GET_STARTED.md</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: C:\Users\mayuchao\Desktop\WASB-SBDT\MODEL_ZOO.md</summary>

</details>
</tool-use>

---


继续阅读评估流程、WASB 模型配置和检测器/跟踪器相关配置。


---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: C:\Users\mayuchao\Desktop\WASB-SBDT\src\configs\eval.yaml</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: C:\Users\mayuchao\Desktop\WASB-SBDT\src\configs\model\wasb.yaml</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: C:\Users\mayuchao\Desktop\WASB-SBDT\src\configs\detector\tracknetv2.yaml</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: C:\Users\mayuchao\Desktop\WASB-SBDT\src\configs\dataset\tennis_predict.yaml</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: C:\Users\mayuchao\Desktop\WASB-SBDT\src\configs\dataset\tennis.yaml</summary>

</details>
</tool-use>

---


继续查看评估运行器、检测器实现和跟踪器配置。


---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: C:\Users\mayuchao\Desktop\WASB-SBDT\src\runners\eval.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: C:\Users\mayuchao\Desktop\WASB-SBDT\src\detectors\detector.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: C:\Users\mayuchao\Desktop\WASB-SBDT\src\detectors\postprocessor.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: C:\Users\mayuchao\Desktop\WASB-SBDT\src\configs\tracker\online.yaml</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: C:\Users\mayuchao\Desktop\WASB-SBDT\src\configs\transform\default.yaml</summary>

</details>
</tool-use>

---


继续查看评估器、runner 配置、dataloader 的 heatmap 配置及跟踪器实现。


---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: C:\Users\mayuchao\Desktop\WASB-SBDT\src\utils\evaluator.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: C:\Users\mayuchao\Desktop\WASB-SBDT\src\configs\runner\eval.yaml</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: C:\Users\mayuchao\Desktop\WASB-SBDT\src\configs\dataloader\default.yaml</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: C:\Users\mayuchao\Desktop\WASB-SBDT\src\trackers\online.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: C:\Users\mayuchao\Desktop\WASB-SBDT\src\dataloaders\dataset_loader.py</summary>

</details>
</tool-use>

---


查看训练相关配置与 config 的完整组合方式。


---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: C:\Users\mayuchao\Desktop\WASB-SBDT\src\runners\train_and_test.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "dist_thresh|dist_threshold",
  "path": "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT\\src",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "dist_thresh|dist_threshold",
    "path": "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT\\src",
    "outputMode": "content",
    "workspaceResults": {
      "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT": {
        "content": {
          "matches": [
            {
              "file": "src\\utils\\refine_gt.py",
              "matches": [
                {
                  "lineNumber": 37,
                  "content": "    dist_thresh = np.sort(v2c_dists)[int(v2c_dists.shape[0]*0.8)]"
                },
                {
                  "lineNumber": 74,
                  "content": "        if dists[cind] &gt; dist_thresh:"
                }
              ]
            },
            {
              "file": "src\\utils\\evaluator.py",
              "matches": [
                {
                  "lineNumber": 8,
                  "content": "        self._dist_threshold = cfg['runner']['eval']['dist_threshold']"
                },
                {
                  "lineNumber": 23,
                  "content": "                if np.linalg.norm( np.array(xy_pred)-np.array(xy_gt) ) &lt; self._dist_threshold:"
                },
                {
                  "lineNumber": 52,
                  "content": "    def dist_threshold(self):"
                },
                {
                  "lineNumber": 53,
                  "content": "        return self._dist_threshold"
                }
              ]
            },
            {
              "file": "src\\runners\\eval.py",
              "matches": [
                {
                  "lineNumber": 37,
                  "content": "                    dist_thresh=10.,"
                },
                {
                  "lineNumber": 127,
                  "content": "            if result['fp1'] &gt; 0 and result['se'] &lt; rescale * dist_thresh:"
                },
                {
                  "lineNumber": 274,
                  "content": "        evaluator.print_results(txt='{} @ dist_threshold={}'.format(self._cfg['model']['name'], evaluator.dist_threshold), "
                }
              ]
            },
            {
              "file": "src\\configs\\runner\\eval.yaml",
              "matches": [
                {
                  "lineNumber": 15,
                  "content": "  dist_threshold: 4"
                }
              ]
            }
          ],
          "totalLines": 10,
          "totalMatchedLines": 10
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: C:\Users\mayuchao\Desktop\WASB-SBDT\src\dataloaders\img_transforms.py</summary>

</details>
</tool-use>

---


正在确认 config 的覆盖方式及 step 在数据加载中的用法。


---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "step|frames_in",
  "path": "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT\\src\\dataloaders",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "step|frames_in",
    "path": "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT\\src\\dataloaders",
    "outputMode": "content",
    "workspaceResults": {
      "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT": {
        "content": {
          "matches": [
            {
              "file": "src\\dataloaders\\dataset_loader.py",
              "matches": [
                {
                  "lineNumber": 72,
                  "content": "        self._frames_in  = cfg['model']['frames_in']"
                },
                {
                  "lineNumber": 76,
                  "content": "        if self._rgb_diff and self._frames_in!=2:"
                },
                {
                  "lineNumber": 77,
                  "content": "            raise ValueError('rgb_diff=True supported only with frames_in=2')"
                }
              ]
            }
          ],
          "totalLines": 3,
          "totalMatchedLines": 3
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: C:\Users\mayuchao\Desktop\WASB-SBDT\src\dataloaders\__init__.py</summary>

</details>
</tool-use>

---


查看数据集如何按 clip 组帧及 `step` 在推理中的用法。


---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "step",
  "path": "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT\\src\\detectors",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "step",
    "path": "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT\\src\\detectors",
    "outputMode": "content",
    "workspaceResults": {
      "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT": {
        "content": {}
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: C:\Users\mayuchao\Desktop\WASB-SBDT\src\dataloaders\samplers\samplers.py</summary>

</details>
</tool-use>

---


查看数据集如何构建 clip 与样本索引。


---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "step|frames_in",
  "path": "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT\\src",
  "glob": "*.py",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "step|frames_in",
    "path": "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT\\src",
    "outputMode": "content",
    "workspaceResults": {
      "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT": {
        "content": {
          "matches": [
            {
              "file": "src\\main.py",
              "matches": [
                {
                  "lineNumber": 31,
                  "content": "#  python main.py --config-name=eval dataset=tennis_predict model=wasb detector.model_path=../pretrained_weights/wasb_tennis_best.pth.tar runner.split=test runner.vis_result=True detector.step=3  #步长为3"
                },
                {
                  "lineNumber": 32,
                  "content": "#  python main.py --config-name=eval dataset=tennis_predict model=wasb detector.model_path=../pretrained_weights/wasb_tennis_best.pth.tar runner.split=test runner.vis_result=True detector.step=1  #步长为1"
                }
              ]
            },
            {
              "file": "src\\runners\\train_and_test.py",
              "matches": [
                {
                  "lineNumber": 64,
                  "content": "        self._step_test         = cfg['runner']['test']['epoch_step']"
                },
                {
                  "lineNumber": 67,
                  "content": "        if self._step_test &lt; 1:"
                },
                {
                  "lineNumber": 68,
                  "content": "            raise ValueError('step_test &gt;= 1, but is set to {}'.format(self._step_test))"
                },
                {
                  "lineNumber": 69,
                  "content": "        #print(self._run_test, self._start_test, self._step_test, self._test_before_train)"
                },
                {
                  "lineNumber": 73,
                  "content": "        self._step_inference_video         = cfg['runner']['inference_video']['epoch_step']"
                },
                {
                  "lineNumber": 76,
                  "content": "        if self._step_inference_video &lt; 1:"
                },
                {
                  "lineNumber": 77,
                  "content": "            raise ValueError('step_inference_video &gt;= 1, but is set to {}'.format(self._step_inference_video))"
                },
                {
                  "lineNumber": 78,
                  "content": "        #print(self._run_inference_video, self._start_inference_video, self._step_inference_video, self._inference_video_before_train)"
                },
                {
                  "lineNumber": 140,
                  "content": "            if (epoch+1 &gt; self._start_test) and ( (epoch+1) % self._step_test==0 or (epoch+1) == self._max_epoch):"
                },
                {
                  "lineNumber": 148,
                  "content": "            if (epoch+1 &gt; self._start_inference_video) and ( (epoch+1) % self._step_inference_video==0 or (epoch+1) == self._max_epoch):"
                },
                {
                  "lineNumber": 178,
                  "content": "            self._scheduler.step()"
                }
              ]
            },
            {
              "file": "src\\runners\\runner_utils.py",
              "matches": [
                {
                  "lineNumber": 31,
                  "content": "        optimizer.step()"
                }
              ]
            },
            {
              "file": "src\\runners\\eval.py",
              "matches": [
                {
                  "lineNumber": 46,
                  "content": "    frames_in  = detector.frames_in"
                },
                {
                  "lineNumber": 58,
                  "content": "        num_frames += imgs.shape[0] * frames_in"
                }
              ]
            },
            {
              "file": "src\\optimizers\\lr_schedulers.py",
              "matches": [
                {
                  "lineNumber": 21,
                  "content": "        if not self._get_lr_called_within_step:"
                },
                {
                  "lineNumber": 50,
                  "content": "        optimizer.step()"
                },
                {
                  "lineNumber": 51,
                  "content": "        scheduler.step()"
                }
              ]
            },
            {
              "file": "src\\optimizers\\__init__.py",
              "matches": [
                {
                  "lineNumber": 13,
                  "content": "        'multistep': optim.lr_scheduler.MultiStepLR,"
                },
                {
                  "lineNumber": 14,
                  "content": "        'multistep_warmup': MultiStepLRWithWarmUp,"
                },
                {
                  "lineNumber": 40,
                  "content": "    if scheduler_name in ['multistep', 'multistep_warmup']:"
                },
                {
                  "lineNumber": 41,
                  "content": "        milestones = cfg['optimizer']['scheduler']['stepsize']"
                }
              ]
            },
            {
              "file": "src\\models\\hrnet.py",
              "matches": [
                {
                  "lineNumber": 258,
                  "content": "        self._frames_in  = cfg['frames_in']"
                },
                {
                  "lineNumber": 264,
                  "content": "        self.conv1 = nn.Conv2d(3*self._frames_in, self._stem_inplanes, kernel_size=3, stride=self._stem_strides[0], padding=1, bias=False)"
                },
                {
                  "lineNumber": 523,
                  "content": "    frames_in  = 3"
                },
                {
                  "lineNumber": 527,
                  "content": "    x = torch.rand((batch_size, 3*frames_in, 288, 512))"
                }
              ]
            },
            {
              "file": "src\\models\\__init__.py",
              "matches": [
                {
                  "lineNumber": 22,
                  "content": "        frames_in  = cfg['model']['frames_in']"
                },
                {
                  "lineNumber": 23,
                  "content": "        frames_out = cfg['model']['frames_in']"
                },
                {
                  "lineNumber": 26,
                  "content": "        model      = __factory[model_name]( frames_in*3, frames_out, bilinear=bilinear, halve_channel=halve_channel)"
                },
                {
                  "lineNumber": 30,
                  "content": "        frames_in        = cfg['model']['frames_in']"
                },
                {
                  "lineNumber": 38,
                  "content": "        model = __factory[model_name]( frames_in*3, "
                },
                {
                  "lineNumber": 46,
                  "content": "        frames_in              = cfg['model']['frames_in']"
                },
                {
                  "lineNumber": 54,
                  "content": "        model = __factory[model_name]( frames_in*3, frames_out*class_out,"
                },
                {
                  "lineNumber": 61,
                  "content": "        frames_in     = cfg['model']['frames_in']"
                },
                {
                  "lineNumber": 65,
                  "content": "        model = __factory[model_name]( in_channels=frames_in*3, nclass=frames_out*1, backbone=backbone, scale_factors=scale_factors)"
                }
              ]
            },
            {
              "file": "src\\detectors\\detector.py",
              "matches": [
                {
                  "lineNumber": 27,
                  "content": "        self._frames_in  = cfg['model']['frames_in']"
                },
                {
                  "lineNumber": 74,
                  "content": "    def frames_in(self):"
                },
                {
                  "lineNumber": 75,
                  "content": "        return self._frames_in"
                }
              ]
            },
            {
              "file": "src\\detectors\\deepball_detector.py",
              "matches": [
                {
                  "lineNumber": 35,
                  "content": "        self._frames_in   = cfg['model']['frames_in']"
                },
                {
                  "lineNumber": 91,
                  "content": "    def frames_in(self):"
                },
                {
                  "lineNumber": 92,
                  "content": "        return self._frames_in"
                }
              ]
            },
            {
              "file": "src\\dataloaders\\dataset_loader.py",
              "matches": [
                {
                  "lineNumber": 72,
                  "content": "        self._frames_in  = cfg['model']['frames_in']"
                },
                {
                  "lineNumber": 76,
                  "content": "        if self._rgb_diff and self._frames_in!=2:"
                },
                {
                  "lineNumber": 77,
                  "content": "            raise ValueError('rgb_diff=True supported only with frames_in=2')"
                }
              ]
            }
          ],
          "totalLines": 45,
          "totalMatchedLines": 45
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: C:\Users\mayuchao\Desktop\WASB-SBDT\src\dataloaders\dataset_loader.py</summary>

</details>
</tool-use>

---


查看数据集如何生成样本索引（是否使用 step）：


---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: C:\Users\mayuchao\Desktop\WASB-SBDT\src\dataloaders\dataset_loader.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "step|stride",
  "path": "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT\\src\\configs",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "step|stride",
    "path": "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT\\src\\configs",
    "outputMode": "content",
    "workspaceResults": {
      "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT": {
        "content": {
          "matches": [
            {
              "file": "src\\configs\\optimizer\\adam_multistep.yaml",
              "matches": [
                {
                  "lineNumber": 5,
                  "content": "  name: multistep"
                },
                {
                  "lineNumber": 6,
                  "content": "  stepsize: [10,20]"
                }
              ]
            },
            {
              "file": "src\\configs\\optimizer\\adadelta_multistep.yaml",
              "matches": [
                {
                  "lineNumber": 5,
                  "content": "  name: multistep"
                },
                {
                  "lineNumber": 6,
                  "content": "  stepsize: [10,20]"
                }
              ]
            },
            {
              "file": "src\\configs\\model\\deepball_large.yaml",
              "matches": [
                {
                  "lineNumber": 15,
                  "content": "first_conv_stride: 2"
                }
              ]
            },
            {
              "file": "src\\configs\\model\\deepball.yaml",
              "matches": [
                {
                  "lineNumber": 15,
                  "content": "first_conv_stride: 2"
                }
              ]
            },
            {
              "file": "src\\configs\\detector\\deepball.yaml",
              "matches": [
                {
                  "lineNumber": 5,
                  "content": "step: 3"
                }
              ]
            },
            {
              "file": "src\\configs\\detector\\tracknetv2.yaml",
              "matches": [
                {
                  "lineNumber": 5,
                  "content": "step: 3"
                }
              ]
            }
          ],
          "totalLines": 8,
          "totalMatchedLines": 8
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="list_dir_v2">
<details>
<summary>Tool use: **list_dir_v2**</summary>


Parameters:

```json
{
  "targetDirectory": "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT\\src\\configs"
}
```
Result:

```json
{
  "directoryTreeRoot": {
    "absPath": "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT\\src\\configs",
    "childrenDirs": [
      {
        "absPath": "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT\\src\\configs\\dataloader",
        "childrenFiles": [
          {
            "name": "default.yaml"
          }
        ],
        "childrenWereProcessed": true
      },
      {
        "absPath": "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT\\src\\configs\\dataset",
        "childrenFiles": [
          {
            "name": "badminton.yaml"
          },
          {
            "name": "basketball.yaml"
          },
          {
            "name": "soccer.yaml"
          },
          {
            "name": "tennis_predict.yaml"
          },
          {
            "name": "tennis.yaml"
          },
          {
            "name": "volleyball.yaml"
          }
        ],
        "childrenWereProcessed": true
      },
      {
        "absPath": "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT\\src\\configs\\detector",
        "childrenFiles": [
          {
            "name": "deepball.yaml"
          },
          {
            "name": "tracknetv2.yaml"
          }
        ],
        "childrenWereProcessed": true
      },
      {
        "absPath": "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT\\src\\configs\\loss",
        "childrenFiles": [
          {
            "name": "hm_bce.yaml"
          },
          {
            "name": "hm_combo.yaml"
          },
          {
            "name": "hm_focal.yaml"
          },
          {
            "name": "hm_mse.yaml"
          },
          {
            "name": "hm_qfl.yaml"
          },
          {
            "name": "hm_wbce_s2.yaml"
          },
          {
            "name": "hm_wbce_s3.yaml"
          },
          {
            "name": "hm_wbce.yaml"
          },
          {
            "name": "seg_ssd.yaml"
          }
        ],
        "childrenWereProcessed": true
      },
      {
        "absPath": "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT\\src\\configs\\model",
        "childrenFiles": [
          {
            "name": "ballseg.yaml"
          },
          {
            "name": "deepball_large.yaml"
          },
          {
            "name": "deepball.yaml"
          },
          {
            "name": "monotrack.yaml"
          },
          {
            "name": "restracknetv2.yaml"
          },
          {
            "name": "tracknetv2.yaml"
          },
          {
            "name": "wasb.yaml"
          }
        ],
        "childrenWereProcessed": true
      },
      {
        "absPath": "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT\\src\\configs\\optimizer",
        "childrenFiles": [
          {
            "name": "adadelta_constant.yaml"
          },
          {
            "name": "adadelta_multistep.yaml"
          },
          {
            "name": "adam_multistep.yaml"
          }
        ],
        "childrenWereProcessed": true
      },
      {
        "absPath": "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT\\src\\configs\\runner",
        "childrenFiles": [
          {
            "name": "eval.yaml"
          },
          {
            "name": "extract_frame.yaml"
          }
        ],
        "childrenWereProcessed": true
      },
      {
        "absPath": "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT\\src\\configs\\tracker",
        "childrenFiles": [
          {
            "name": "intra_frame_peak.yaml"
          },
          {
            "name": "online.yaml"
          }
        ],
        "childrenWereProcessed": true
      },
      {
        "absPath": "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT\\src\\configs\\transform",
        "childrenFiles": [
          {
            "name": "color.yaml"
          },
          {
            "name": "crop.yaml"
          },
          {
            "name": "default.yaml"
          },
          {
            "name": "full.yaml"
          },
          {
            "name": "hflip.yaml"
          }
        ],
        "childrenWereProcessed": true
      }
    ],
    "childrenFiles": [
      {
        "name": "eval.yaml"
      },
      {
        "name": "extract_frame.yaml"
      }
    ],
    "childrenWereProcessed": true
  }
}
```
Status: **completed**


</details>
</tool-use>

---


查看 datasets 如何构建 clip 列表及是否使用 step：


---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "step|stride|frames_in",
  "path": "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT\\src",
  "glob": "*dataset*",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "step|stride|frames_in",
    "path": "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT\\src",
    "outputMode": "content",
    "workspaceResults": {
      "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT": {
        "content": {
          "matches": [
            {
              "file": "src\\dataloaders\\dataset_loader.py",
              "matches": [
                {
                  "lineNumber": 72,
                  "content": "        self._frames_in  = cfg['model']['frames_in']"
                },
                {
                  "lineNumber": 76,
                  "content": "        if self._rgb_diff and self._frames_in!=2:"
                },
                {
                  "lineNumber": 77,
                  "content": "            raise ValueError('rgb_diff=True supported only with frames_in=2')"
                }
              ]
            }
          ],
          "totalLines": 3,
          "totalMatchedLines": 3
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: C:\Users\mayuchao\Desktop\WASB-SBDT\src\utils\dataclasses.py</summary>

</details>
</tool-use>

---





---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "detector.*step|cfg\\['detector'\\]",
  "path": "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT\\src",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "detector.*step|cfg\\['detector'\\]",
    "path": "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT\\src",
    "outputMode": "content",
    "workspaceResults": {
      "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT": {
        "content": {
          "matches": [
            {
              "file": "src\\main.py",
              "matches": [
                {
                  "lineNumber": 31,
                  "content": "#  python main.py --config-name=eval dataset=tennis_predict model=wasb detector.model_path=../pretrained_weights/wasb_tennis_best.pth.tar runner.split=test runner.vis_result=True detector.step=3  #步长为3"
                },
                {
                  "lineNumber": 32,
                  "content": "#  python main.py --config-name=eval dataset=tennis_predict model=wasb detector.model_path=../pretrained_weights/wasb_tennis_best.pth.tar runner.split=test runner.vis_result=True detector.step=1  #步长为1"
                }
              ]
            },
            {
              "file": "src\\detectors\\postprocessor.py",
              "matches": [
                {
                  "lineNumber": 11,
                  "content": "        #print(cfg['detector']['postprocessor'])"
                },
                {
                  "lineNumber": 12,
                  "content": "        self._score_threshold = cfg['detector']['postprocessor']['score_threshold']"
                },
                {
                  "lineNumber": 14,
                  "content": "        self._scales          = cfg['detector']['postprocessor']['scales']"
                },
                {
                  "lineNumber": 15,
                  "content": "        self._blob_det_method = cfg['detector']['postprocessor']['blob_det_method']"
                },
                {
                  "lineNumber": 16,
                  "content": "        self._use_hm_weight   = cfg['detector']['postprocessor']['use_hm_weight']"
                },
                {
                  "lineNumber": 17,
                  "content": "        #self._xy_comp_method  = cfg['detector']['postprocessor']['xy_comp_method']"
                }
              ]
            },
            {
              "file": "src\\detectors\\__init__.py",
              "matches": [
                {
                  "lineNumber": 10,
                  "content": "    detector_name = cfg['detector']['name'] "
                }
              ]
            },
            {
              "file": "src\\detectors\\deepball_detector.py",
              "matches": [
                {
                  "lineNumber": 66,
                  "content": "            model_path = cfg['detector']['model_path']"
                },
                {
                  "lineNumber": 84,
                  "content": "        postprocessor_name = cfg['detector']['postprocessor']['name']"
                }
              ]
            },
            {
              "file": "src\\detectors\\deepball_postprocessor.py",
              "matches": [
                {
                  "lineNumber": 12,
                  "content": "        #print(cfg['detector']['postprocessor'])"
                },
                {
                  "lineNumber": 13,
                  "content": "        self._score_threshold = cfg['detector']['postprocessor']['score_threshold']"
                },
                {
                  "lineNumber": 14,
                  "content": "        self._scales = cfg['detector']['postprocessor']['scales']"
                }
              ]
            },
            {
              "file": "src\\detectors\\detector.py",
              "matches": [
                {
                  "lineNumber": 31,
                  "content": "        self._scales          = cfg['detector']['postprocessor']['scales']"
                },
                {
                  "lineNumber": 51,
                  "content": "            model_path = cfg['detector']['model_path']"
                },
                {
                  "lineNumber": 67,
                  "content": "        postprocessor_name = cfg['detector']['postprocessor']['name']"
                }
              ]
            }
          ],
          "totalLines": 17,
          "totalMatchedLines": 17
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: C:\Users\mayuchao\Desktop\WASB-SBDT\src\dataloaders\samplers\__init__.py</summary>

</details>
</tool-use>

---





---

<tool-use data-tool-type="generic" data-tool-name="glob_file_search">
<details>
<summary>Tool use: **glob_file_search** • Searched codebase "undefined" • **0** result in **1** directory</summary>

Directory: **C:\Users\mayuchao\Desktop\WASB-SBDT** (0 file)

</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "select_dataset|train_clips|test_clips",
  "path": "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT\\src",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "select_dataset|train_clips|test_clips",
    "path": "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT\\src",
    "outputMode": "content",
    "workspaceResults": {
      "C:\\Users\\mayuchao\\Desktop\\WASB-SBDT": {
        "content": {
          "matches": [
            {
              "file": "src\\dataloaders\\samplers\\__init__.py",
              "matches": [
                {
                  "lineNumber": 53,
                  "content": "    train_clips         = dataset.train_clips"
                },
                {
                  "lineNumber": 55,
                  "content": "    for key, clip in train_clips.items():"
                },
                {
                  "lineNumber": 63,
                  "content": "    test_clips         = dataset.test_clips"
                },
                {
                  "lineNumber": 65,
                  "content": "    for key, clip in test_clips.items():"
                }
              ]
            },
            {
              "file": "src\\dataloaders\\__init__.py",
              "matches": [
                {
                  "lineNumber": 11,
                  "content": "from datasets import select_dataset"
                },
                {
                  "lineNumber": 35,
                  "content": "    dataset = select_dataset(cfg)"
                },
                {
                  "lineNumber": 73,
                  "content": "        for key, clip in dataset.train_clips.items():"
                },
                {
                  "lineNumber": 83,
                  "content": "        for key, clip in dataset.test_clips.items():"
                }
              ]
            }
          ],
          "totalLines": 8,
          "totalMatchedLines": 8
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---


已阅读项目核心逻辑。正在撰写详细说明文档。


---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** • Edit file: C:\Users\mayuchao\Desktop\WASB-SBDT\WASB推理调参与提精度说明.md</summary>

</details>

</tool-use>

---


已经根据你当前项目整理成一份说明文档，并写入了 **`WASB推理调参与提精度说明.md`**。下面是精简版总结，方便你直接照着用。

---

## 1. 项目与训练过程（只作了解）

- **入口**：`main.py` 默认用 `config_name=eval`，走的是**评估/推理**，不是训练。
- **训练**：仓库里有训练逻辑（`runners/train_and_test.py`），但 GET_STARTED 里写的是 TBA，没有给出具体训练命令；你只用现有权重的话，**不用动训练过程**。
- **推理流程**：按 clip 加载图像 → WASB(HRNet) 出热图 → **后处理**（阈值 + 连通分量/NMS）得到球位置 → **在线跟踪器**做帧间关联 → 若有 GT 再算 Precision/Recall/F1 等。

---

## 2. 不改代码、只用现有 WASB 权重时，能做什么来提高预测精度

下面全部通过 **命令行参数** 或 **改 YAML 配置** 完成，**不需要改任何 .py 代码**。

### 最值得先做的两件事

1. **`detector.step=1`**  
   - 默认是 `step=3`（每 3 帧推理一次）。  
   - 改成 **step=1** 后每帧都推理，**精度通常会提高**，论文里也有 Step=1 比 Step=3 更准的对比；代价是推理更慢。  
   - 示例：在原有命令后加 `detector.step=1`。

2. **调 `detector.postprocessor.score_threshold`**  
   - 默认 0.5，是热图二值化的阈值。  
   - **漏检多**：可尝试**降低**，如 `0.4` 或 `0.45`，会多检出一些球，提高召回。  
   - **误检多**：可尝试**提高**，如 `0.55` 或 `0.6`，会少一些误检，提高精确率。  
   - 建议在 0.35～0.6 之间小步长试几次，看 F1/Recall/Precision 变化。

### 其他可调参数（按需使用）

- **`detector.postprocessor.use_hm_weight`**  
  - 保持 **True**（默认）即可，一般比 False 定位更准。

- **`detector.postprocessor.blob_det_method`**  
  - 默认 `concomp`（连通分量）。若热图经常多峰、碎块多，可以试 **`nms`**。

- **`tracker.max_disp`**（默认 300）  
  - 相邻两帧允许的最大位移（像素）。  
  - 球速很快、轨迹经常断 → 可**适当增大**（如 350、400）。  
  - 经常误跟到别的物体 → 可**适当减小**（如 250）。

- **`runner.eval.dist_threshold`**（默认 4）  
  - 只影响“多少像素内算预测正确”，从而影响 Prec/Recall/F1 等**指标数值**，**不改变模型输出**。  
  - 想更严格可改小（如 3），更宽松可改大（如 5）。

---

## 3. 一条“尽量提高精度”的示例命令（仅改参数）

在 **PowerShell** 里（在 `src` 目录下跑时）：

```powershell
cd C:\Users\mayuchao\Desktop\WASB-SBDT\src
python main.py --config-name=eval dataset=tennis_predict model=wasb detector.model_path=../pretrained_weights/wasb_tennis_best.pth.tar detector.step=1 detector.postprocessor.score_threshold=0.45 runner.split=test runner.vis_result=True
```

如需看热图或轨迹，可再加：  
`runner.vis_hm=True runner.vis_traj=True`  
根据漏检/误检再微调 **score_threshold** 和 **tracker.max_disp** 即可。

---

## 4. 文档位置与内容

更细的说明（每个参数含义、默认值、调参建议、以及和训练/评估流程的关系）都写在项目根目录下的 **`WASB推理调参与提精度说明.md`** 里，你可以打开该文件按章节查阅。  
总结：**不改代码、只用现有 WASB 权重**时，优先做 **step=1** 和 **score_threshold** 的微调，再按现象调 **max_disp** 和 **blob_det_method**，就能在现有设定下尽量提高预测精度。

---

_**User**_

现在可视化输出的结果里面一直有之前帧检测出来的点的轨迹，很影响视线，可不可以让可视化的结果只包含当前帧中检测出来的结果，不要包含之前帧的检测结果，先帮我检查代码，先不要改代码

---

_**Agent (model default, mode Agent)**_

<think><details><summary>Thought Process</summary>
**Explaining visualization of trajectory overlay**

Visualization with previous frames overlaid happens in `src/runners/eval.py` within the function handling inference video. Around lines 260–280, it iterates through `result_dict` keys (`for cnt, img_path in enumerate(...)`), and inside that loop, another loop (`for cnt2 in range(cnt)`) draws past frames onto the current one to build the trajectory overlay. This overlays past frame visual data onto the current frame as part of evaluation inference visualization without modifying code. 

```python
260:280:src/runners/eval.py
```</details></think>

---

这里的可视化之所以叠加了历史帧的点，是因为在生成可视化帧时，循环把“当前帧之前的所有结果”都画上去了，用来画轨迹。在 `src/runners/eval.py` 的 `inference_video` 中，大致逻辑如下：

```170:252:C:\Users\mayuchao\Desktop\WASB-SBDT\src\runners\eval.py
        if vis_frame_dir is not None:
            vis_frame_path = osp.join(vis_frame_dir, osp.basename(img_path)) if vis_frame_dir is not None else None
            vis_gt         = cv2.imread(img_path)
            vis_pred       = cv2.imread(img_path)

            for cnt2, img_path2 in enumerate(result_dict.keys()):
                if cnt2 > cnt:
                    break

                x_pred = result_dict[img_path2]['x']
                y_pred = result_dict[img_path2]['y']
                ...
                vis_pred   = draw_frame(
                    vis_pred,
                    center = Center(is_visible=visi_pred, x=x_pred, y=y_pred),
                    color = color_pred,
                    radius=8
                )
```

- 外层 `for cnt, img_path in enumerate(result_dict.keys()):` 以当前帧为基准。
- 内层 `for cnt2, img_path2 in enumerate(result_dict.keys()): if cnt2 > cnt: break` 会把 **从第一帧到当前帧** 的所有预测都画上去，所以你看到的是累计的轨迹，而不是只画当前帧的预测。

如果要“只显示当前帧的检测，不显示历史轨迹”，需要让可视化部分只画 `img_path` 当前帧的预测，而不是遍历 `result_dict` 的全部历史。当前代码就是导致轨迹叠加的原因。你如果确认要改，我再给出最小改动建议。

---

_**User**_

帮我进行修改

---

_**Agent (model default, mode Agent)**_

<think><details><summary>Thought Process</summary>
**Editing code for visualization**

I need to edit eval.py to draw only the current frame point. First, I'll read the file to ensure I understand the content since I've already checked it earlier. My next step is to apply a patch: I'll replace the inner loop over history in the visualization loop with just the current frame image path. I should also make sure not to draw ground truth if it's None, and I can keep the color based on count, although that might not be necessary. I'll aim for simplicity by removing the inner loop and just drawing one point.</details></think>

---

我会只改可视化绘制那一段：把“从第 1 帧累计画到当前帧”的内层循环去掉，改成**每张输出图只画当前帧的预测点**（以及可选的当前帧 GT 点），其余推理与评估逻辑不动。接着我会检查一下该文件有没有引入新的语法/风格问题。

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: C:\Users\mayuchao\Desktop\WASB-SBDT\src\runners\eval.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: C:\Users\mayuchao\Desktop\WASB-SBDT\src\runners\eval.py</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="edit_file_v2">

<details><summary>Tool use: **edit_file_v2** • Edit file: C:\Users\mayuchao\Desktop\WASB-SBDT\src\runners\eval.py</summary>

</details>

</tool-use>

---

